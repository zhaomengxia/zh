<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zh.mapper.data.CockpitMapper">


    <!-- 通用查询结果列 -->
    <sql id="Site_Info_List">
        id, site_id, factor_code, value, time, is_deleted
    </sql>
    <select id="getSiteMapInfo" resultType="com.zh.dto.data.SiteMapInfoDTO">
        select
        id siteId,
        code siteCode,
        name siteName,
        latitude latitude,
        longitude longitude
        from site
        where is_deleted = 0
    </select>

    <!-- 获取监测点最新预警信息 -->
    <select id="getNewestSiteWarning" resultType="com.zh.dto.data.SiteWarningDTO">
        select
        wr.site_id siteId,
        wr.warning_time warningTime,
        wr.factor_code factorCode,
        wr.warning_degree degreeId,
        wr.data_value dataValue,
        wr.warning_value warningValue,
        wr.warning_detail warningDetail,
        a.factorName factorName,
        a.degreeName degreeName,
        a.degreeIcon degreeIcon
        from warning_record wr,(
        SELECT
        MAX (w.warning_time) TIME,
        w.factor_code factorCode,
        f.factor_name factorName,
        wd.name degreeName,
        wd.icon degreeIcon
        FROM
        warning_record w
        LEFT JOIN device_factor df ON w.factor_code = df.factor_code
        LEFT JOIN factor f ON df.factor_id = f.id
        LEFT JOIN warning_degree wd ON wd.id = w.warning_degree
        WHERE
        w.is_deleted = 0
        AND df.is_deleted = 0
        AND f.is_deleted = 0
        and status <![CDATA[ < ]]> 5
        GROUP BY
        w.factor_code,
        f.factor_name,
        wd.name,
        wd.icon
        ) as a
        where wr.factor_code = a.factorCode
        and wr.warning_time = a.time
        <if test="siteId != null and siteId != ''">
            <bind name="siteId" value="siteId"/>
            and wr.site_id = #{siteId}
        </if>
    </select>

    <!-- 查询监测点因子实时数据 -->
    <select id="getSiteFactorRealTimeData" resultType="com.zh.dto.data.SiteRealTimeDataDTO">

    </select>

    <!-- 查询监测点所有因子信息 -->
    <select id="getSiteFactorInfo" resultType="com.zh.dto.data.SiteFactorDTO">
        SELECT
	    df.factor_code factorCode,
	    s.id siteId,
	    df.factor_id factorId
        FROM
	    device_factor df
        LEFT JOIN device d ON d.id = df.device_id
        LEFT JOIN site s ON d.site_id = s.id
        WHERE
	    df.is_deleted = 0
        AND d.is_deleted = 0
        AND s.is_deleted = 0
    </select>

    <!-- 查询水位小时平均数据 -->
    <select id="getAvgHourData" resultType="com.zh.dto.data.SiteRealTimeDataDTO">
        select
        avg(sfdm.value) dataValue,
        sfdm.site_id siteId,
        sfdm.factor_code factorCode,
        df.factor_id factorId
        from site_factor_data_minute sfdm
        left join device_factor df
        on df.factor_code = sfdm.factor_code
        where sfdm.time <![CDATA[ >= ]]> #{beginTime}
        and sfdm.time <![CDATA[ < ]]> #{endTime}
        and sfdm.is_deleted = 0
        and (df.factor_id = 1 or df.factor_id = 2)
        group by sfdm.site_id, sfdm.factor_code, df.factor_id
    </select>

    <!-- 查询雨量小时总计数据 -->
    <select id="getSumHourData" resultType="com.zh.dto.data.SiteRealTimeDataDTO">
        select
        sum(sfdm.value) dataValue,
        sfdm.site_id siteId,
        sfdm.factor_code factorCode,
        df.factor_id factorId
        from site_factor_data_minute sfdm
        left join device_factor df
        on df.factor_code = sfdm.factor_code
        where sfdm.time <![CDATA[ >= ]]> #{beginTime}
        and sfdm.time <![CDATA[ < ]]> #{endTime}
        and sfdm.is_deleted = 0
        and df.factor_id = 3
        group by sfdm.site_id, sfdm.factor_code, df.factor_id
    </select>

    <!-- 查询水位天平均数据 -->
    <select id="getAvgDayData" resultType="com.zh.dto.data.SiteRealTimeDataDTO">
        select
        avg(sfdh.value) dataValue,
        sfdh.site_id siteId,
        sfdh.factor_code factorCode,
        df.factor_id factorId
        from site_factor_data_hour sfdh
        left join device_factor df
        on df.factor_code = sfdh.factor_code
        where sfdh.time <![CDATA[ >= ]]> #{beginTime}
        and sfdh.time <![CDATA[ < ]]> #{endTime}
        and sfdh.is_deleted = 0
        and (df.factor_id = 1 or df.factor_id = 2)
        group by sfdh.site_id, sfdh.factor_code, df.factor_id
    </select>

    <!-- 查询雨量天总计数据 -->
    <select id="getSumDayData" resultType="com.zh.dto.data.SiteRealTimeDataDTO">
        select
        sum(sfdh.value) dataValue,
        sfdh.site_id siteId,
        sfdh.factor_code factorCode,
        df.factor_id factorId
        from site_factor_data_hour sfdh
        left join device_factor df
        on df.factor_code = sfdh.factor_code
        where sfdh.time <![CDATA[ >= ]]> #{beginTime}
        and sfdh.time <![CDATA[ < ]]> #{endTime}
        and sfdh.is_deleted = 0
        and df.factor_id = 3
        group by sfdh.site_id, sfdh.factor_code, df.factor_id
    </select>

    <!-- 查询关键监测点水位每隔十分钟的分钟历史数据 -->
    <select id="getLevelTimeData" resultType="com.zh.dto.data.SiteRealTimeDataDTO">
        SELECT
        sfdm.time valueTime,
        sfdm.factor_code factorCode,
        sfdm.site_id siteId,
        sfdm.value dataValue
        FROM
	    site_factor_data_minute sfdm
        LEFT JOIN device_factor df on df.factor_code = sfdm.factor_code
        LEFT JOIN site s on sfdm.site_id = s.id
        WHERE
        DATEPART(mi,DATEADD (MS ,sfdm.time % 60000 ,DATEADD(MI,sfdm.time / 60000,'1970-01-01 08:00:00.000'))) %30 = 0
        and df.factor_id = #{factorId} and s.is_focus = 1
        and sfdm.time <![CDATA[ >= ]]> #{beginTime}
        and sfdm.time <![CDATA[ < ]]> #{endTime}
        and df.is_deleted = 0 and s.is_deleted = 0 and sfdm.is_deleted = 0
    </select>




    <select id="getKeySiteList" resultType="com.zh.dto.data.KeyPointDataDTO">
        select
        id siteId,
        name siteName
        from site
        where is_focus = 1 and is_deleted = 0
        <if test="siteId != null and siteId != ''">
            <bind name="siteId" value="siteId"/>
            and id = #{siteId}
        </if>
    </select>


    <select id="getRainHourData" resultType="com.zh.dto.data.SiteRealTimeDataDTO">
        SELECT
	    sfdh.time valueTime,
	    sfdh.factor_code factorCode,
	    sfdh.site_id siteId,
	    sfdh.value dataValue
        FROM
	    site_factor_data_hour sfdh
        LEFT JOIN device_factor df ON df.factor_code = sfdh.factor_code
        LEFT JOIN site s ON sfdh.site_id = s.id
        WHERE
	    df.factor_id = 3
	    and sfdh.time <![CDATA[ >= ]]> #{beginTime}
        and sfdh.time <![CDATA[ < ]]> #{endTime}
        AND s.is_focus = 1
        AND df.is_deleted = 0
    </select>


    <select id="getSiteArea" resultType="com.zh.dto.data.AreaDetailDTO">
        select
        s.longitude longitude,
        s.latitude latitude,
        bad.division_name areaName,
        bad.total_peoples totalPopulation,
        bad.total_family totalFamily
        from site s
        left join basic_administrative_division bad on s.area_code = bad.division_code
        where s.id = #{siteId} and s.is_deleted = 0
    </select>


    <select id="getAvgRainHourData" resultType="java.lang.Double">
        select
        avg(sfdh.value) data
        from site_factor_data_hour sfdh
        left join device_factor df on  sfdh.factor_code = df.factor_code
        where
        df.factor_id = 3
	    and sfdh.time <![CDATA[ >= ]]> #{beginTime}
        and sfdh.time <![CDATA[ < ]]> #{endTime}
        and df.is_deleted = 0
    </select>


    <select id="getLevelTimeDataDetail" resultType="com.zh.dto.data.SiteRealTimeDataDTO">
        SELECT
        sfdm.time valueTime,
        sfdm.factor_code factorCode,
        sfdm.site_id siteId,
        sfdm.value dataValue
        FROM
	    site_factor_data_minute sfdm
        LEFT JOIN device_factor df on df.factor_code = sfdm.factor_code
        LEFT JOIN site s on sfdm.site_id = s.id
        WHERE
        DATEPART(mi,DATEADD (MS ,sfdm.time % 60000 ,DATEADD(MI,sfdm.time / 60000,'1970-01-01 08:00:00.000'))) %10 = 0
        and df.factor_id = #{factorId} and s.is_focus = 1
        and sfdm.time <![CDATA[ >= ]]> #{beginTime}
        and sfdm.time <![CDATA[ < ]]> #{endTime}
        and df.is_deleted = 0 and s.is_deleted = 0 and sfdm.is_deleted = 0
        <if test="siteId != null and siteId != ''">
            <bind name="siteId" value="siteId"/>
            and s.id = #{siteId}
        </if>
    </select>

</mapper>
